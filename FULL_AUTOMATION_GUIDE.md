# 完全自动化构建指南 - 直到编译成功

## ✅ 已实现的自动化功能

现在你可以实现完全自动化构建流程：**自动提交 → 检查构建 → 自动修复 → 重复直到成功**

## 🚀 三种使用方法

### 方法一：在 Cursor 中使用自然语言（最简单）⭐

直接在 Cursor 聊天中说：

```
"帮我实现完全自动化构建，自动检查构建状态，如果失败就分析错误并修复，重复直到编译成功"
```

或者更简单：

```
"自动修复构建错误直到成功"
```

AI 会自动执行：
1. ✅ 检查当前构建状态
2. ✅ 如果有未提交的更改，自动提交并推送
3. ✅ 等待 GitHub Actions 构建完成
4. ✅ 如果失败，自动获取错误日志
5. ✅ 分析错误并自动修复代码
6. ✅ 提交修复并推送
7. ✅ 重复步骤 3-6 直到构建成功

### 方法二：使用自动化脚本

#### 选项 A: Node.js 脚本（需要 GitHub Token）

```bash
# 设置 GitHub Token（可选但推荐）
export GITHUB_TOKEN=your_github_token

# 运行自动化脚本
npm run auto-build "你的提交信息"
```

或者：

```bash
node scripts/auto-build-until-success.js "你的提交信息"
```

#### 选项 B: Shell 脚本（交互式）

```bash
./scripts/quick-auto-fix.sh
```

或者：

```bash
npm run auto-fix
```

### 方法三：分步手动控制

如果你想分步控制，可以在 Cursor 中使用：

```
1. "列出 Build WinUnlock 工作流程的最新运行"
2. "如果构建失败，下载最新失败的工作流程运行的日志"
3. "根据这个构建错误修复代码：[粘贴错误]"
4. "提交修复并推送"
5. "再次检查最新工作流程运行的状态"
6. 如果还是失败，重复步骤 2-5
```

## 📋 完整工作流程

```
┌─────────────────────────────────────────┐
│  1. 提交代码（如果有更改）                │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  2. 推送到 GitHub                        │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  3. 等待 GitHub Actions 构建             │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  4. 检查构建状态                         │
└──────────────┬──────────────────────────┘
               │
        ┌──────┴──────┐
        │             │
        ▼             ▼
    ┌───────┐    ┌──────────┐
    │ 成功  │    │  失败    │
    └───┬───┘    └────┬─────┘
        │             │
        │             ▼
        │    ┌─────────────────┐
        │    │ 5. 获取错误日志 │
        │    └────────┬────────┘
        │             │
        │             ▼
        │    ┌─────────────────┐
        │    │ 6. 分析并修复   │
        │    └────────┬────────┘
        │             │
        │             ▼
        │    ┌─────────────────┐
        │    │ 7. 提交并推送   │
        │    └────────┬────────┘
        │             │
        └─────────────┘
               │
               ▼
        ┌──────────────┐
        │ 重复步骤 3-7│
        └──────────────┘
```

## 🎯 实际使用示例

### 示例 1: 完全自动化（推荐）

```
你: "自动修复构建错误直到成功"

AI: [开始自动化流程]
AI: "1. 检查当前构建状态..."
AI: [使用 GitHub MCP] "最新运行 #456，状态：失败"
AI: "2. 获取错误日志..."
AI: [下载日志] "错误：缺少头文件 'credentialprovider.h'"
AI: "3. 修复错误..."
AI: [修复代码] "已添加缺失的头文件"
AI: "4. 提交并推送..."
AI: [提交推送] "已推送，等待新构建..."
AI: "5. 检查新构建..."
AI: [检查] "✅ 构建成功！任务完成！"
```

### 示例 2: 使用脚本

```bash
# 终端中运行
$ npm run auto-build "修复编译错误"

🚀 开始完全自动化构建流程...
📌 目标：自动修复直到构建成功

==========================================
🔄 尝试 #1/10
==========================================
📝 提交更改...
✅ 代码已提交
🚀 推送到远程分支 dev...
✅ 代码已推送
📌 提交 SHA: 5171e84...

⏳ 等待 GitHub Actions 构建完成...
📊 检查构建状态...
✅ 构建成功！任务完成！
```

## 🔧 配置选项

### 设置 GitHub Token（推荐）

```bash
export GITHUB_TOKEN=your_github_personal_access_token
```

获取 Token: https://github.com/settings/tokens/new
需要权限：`repo`, `actions:read`

### 调整脚本参数

编辑 `scripts/auto-build-until-success.js`：

```javascript
const CONFIG = {
  maxRetries: 10,        // 最多重试次数
  checkInterval: 30000,  // 检查间隔（30秒）
  maxWaitTime: 600000,   // 最大等待时间（10分钟）
};
```

## 📊 监控和调试

### 查看构建历史

在 Cursor 中：
```
"列出 Build WinUnlock 工作流程的所有运行"
"列出状态为失败的工作流程运行"
```

### 分析失败模式

```
"分析最近 5 次失败的构建，找出共同原因"
```

### 查看详细日志

```
"下载工作流程运行 #123 的完整日志"
```

## 🎯 最佳实践

1. **使用 Cursor AI 完全自动化**：最简单高效
2. **小步提交**：每次修复一个错误，便于定位
3. **描述性提交信息**：使用清晰的提交信息
4. **及时检查**：推送后立即检查构建状态
5. **利用 AI 分析**：让 AI 分析错误模式
6. **本地测试**：在本地先测试，减少失败次数

## 🚨 故障排除

### 构建一直失败

```
"分析最近 5 次失败的构建，找出根本原因并修复"
```

### 无法获取工作流程运行

- 检查 GitHub Token 是否正确设置
- 确认 Token 有 `actions:read` 权限
- 检查网络连接

### 自动化脚本无法运行

- 确保已安装 Node.js
- 检查脚本权限：`chmod +x scripts/auto-build-until-success.js`
- 设置 GitHub Token

### Cursor AI 无法访问 GitHub

- 检查 GitHub MCP Server 配置
- 确认 `~/.cursor/mcp.json` 配置正确
- 重启 Cursor

## 📚 相关文档

- `.cursor/auto-build-until-success.md` - Cursor AI 自动化工作流
- `.cursor/auto-fix-workflow.md` - 详细使用说明
- `scripts/auto-build-until-success.js` - Node.js 自动化脚本
- `scripts/quick-auto-fix.sh` - Shell 自动化脚本
- `GITHUB_WORKFLOWS_GUIDE.md` - GitHub MCP Server 工作流程功能指南

## ✨ 总结

现在你有三种方式实现完全自动化构建：

1. **Cursor AI 自然语言**（最简单）⭐
   - 直接说："自动修复构建错误直到成功"

2. **Node.js 脚本**（需要 GitHub Token）
   - `npm run auto-build "提交信息"`

3. **Shell 脚本**（交互式）
   - `./scripts/quick-auto-fix.sh`

**推荐使用方法一**，在 Cursor 中直接使用自然语言命令，AI 会自动处理所有步骤！

---

**现在你可以实现完全自动化的构建流程了！** 🎉

